<!DOCTYPE html>
<html>
<head>
    <title>EMDR Tapper</title>
    <script>
        function updateControllerList() {
            const gamepads = navigator.getGamepads();
            const controllerList = document.getElementById("controller-list");
            controllerList.innerHTML = ""; // Clear existing list

            for (const gamepad of gamepads) {
                if (gamepad) {
                    const listItem = document.createElement("li");
                    listItem.textContent = `${gamepad.id} (Index: ${gamepad.index})`;
                    controllerList.appendChild(listItem);
                }
            }
        }

        async function runTapperPattern() {
            const gamepads = navigator.getGamepads();
            const leftJoyCon = Array.from(gamepads).find(gp => gp && gp.id.includes("Joy-Con (L)"));
            const rightJoyCon = Array.from(gamepads).find(gp => gp && gp.id.includes("Joy-Con (R)"));

            if (!leftJoyCon || !rightJoyCon) {
                alert("Both a left and right Joy-Con are required for the tapper pattern.");
                return;
            }

            for (let i = 0; i < 4; i++) { // Repeat pattern 4 times
                await leftJoyCon.vibrationActuator.playEffect("dual-rumble", {
                    startDelay: 0,
                    duration: 50,
                    strongMagnitude: 0.8,
                    weakMagnitude: 0.0
                });
                await new Promise(resolve => setTimeout(resolve, 100));

                await rightJoyCon.vibrationActuator.playEffect("dual-rumble", {
                    startDelay: 0,
                    duration: 50,
                    strongMagnitude: 0.8,
                    weakMagnitude: 0.0
                });
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        function pollGamepadInput() {
            const gamepads = navigator.getGamepads();
            const rightJoyCon = Array.from(gamepads).find(gp => gp && gp.id.includes("Joy-Con (R)"));

            updateControllerList();

            if (!rightJoyCon) {
                console.log("Waiting for Joy-Con (R) to be paired.");
                return;
            }

            for (const gamepad of gamepads) {
                if (gamepad && gamepad.buttons[7]?.pressed) { // Right Trigger
                    runTapperPattern();
                }
            }
            requestAnimationFrame(pollGamepadInput);
        }

        window.addEventListener("gamepadconnected", pollGamepadInput);
        window.addEventListener("gamepadconnected", updateControllerList);
        window.addEventListener("gamepaddisconnected", updateControllerList);
    </script>
</head>
<body>
    <h1>EMDR Tapper</h1>
    <button onclick="runTapperPattern()">Start Tapper Pattern</button>
    <h2>Connected Controllers:</h2>
    <ul id="controller-list"></ul>
</body>
</html>
